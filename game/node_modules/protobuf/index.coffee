# requires
fs = require 'fs'
zlib = require 'zlib'
protobuf = require 'protobufjs'

# globals
builder = protobuf.loadProtoFile __dirname + '/formats.proto'
proto = builder.build 'Settings'

# helpers
wcharToStr = (buf) ->
  str = ''
  str += String.fromCharCode buf.readUint16() while buf.remaining() > 0
  str

strToWchar = (str) ->
  len = str.length
  buf = new Buffer len * 2
  for i in [0...len] by 1
    buf.writeUInt16LE str.charCodeAt(i), i * 2
  buf

# exports
module.exports = ->

module.exports.build = (obj) ->
  for group in obj.data
    {data} = group

    # convert str back to wchar byte array
    switch group.name
      when 'S1ChatController'
        for tab in data.tabs
          tab.name = strToWchar tab.name
          tab.autochangeChannelName = strToWchar tab.autochangeChannelName
          for channel in tab.channels
            channel.name = strToWchar channel.name
        for channel in data.channels
          channel.name = strToWchar channel.name
      when 'S1UI_GFxManager'
        for item in data.unk1
          item.name = strToWchar item.name
        for item in data.unk2
          item.name = strToWchar item.name
          item.data = strToWchar item.data

    message = builder.build group.name
    data = message.encode data

    group.name = strToWchar group.name
    group.data = data.toBuffer()
    group.length = group.data.length

    if group.zipped
      group.data = zlib.deflateSync group.data

  buf = proto.encode obj
  buf.toBuffer()

module.exports.parse = (buf) ->
  settings = proto.decode buf

  for group in settings.data
    group.name = wcharToStr group.name
    group.data = group.data.toBuffer()

    if group.zipped
      group.data = zlib.inflateSync group.data

    if group.data.length isnt group.length
      console.warn "settings group '%s' size: %d (expected: %d, zipped: %s)",
        group.name, group.data.length, group.length, group.zipped

    try
      message = builder.build group.name
      data = message.decode group.data

      # convert wchar byte array to str
      switch group.name
        when 'S1ChatController'
          for tab in data.tabs
            tab.name = wcharToStr tab.name
            tab.autochangeChannelName = wcharToStr tab.autochangeChannelName
            for channel in tab.channels
              channel.name = wcharToStr channel.name
          for channel in data.channels
            channel.name = wcharToStr channel.name
        when 'S1UI_GFxManager'
          for item in data.unk1
            item.name = wcharToStr item.name
          for item in data.unk2
            item.name = wcharToStr item.name
            item.data = wcharToStr item.data
      group.data = data

  settings
